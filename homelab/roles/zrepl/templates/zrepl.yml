# This file is managed by ansible, do not modify manually.

# rpool/ROOT  -> snapshots, backup to hdd1/rpool_backup
# rpool/data  -> snapshots, backup to hdd1/rpool_backup
# rpool/pve   -> snapshots, backup to hdd0/pbs_datastore using PBS

# hdd0/storage -> snapshots, backup to hdd1/hdd0_backup/storage
# hdd0/other -> backup to hdd1/hdd0_backup/other

# cloud backup: hdd0/storage & hdd0/pbs_datastore & rpool/data


jobs:
  # this job takes care of snapshot creation + pruning
  - type: snap
    name: snapshot_all
    filesystems: { "rpool<": true, "hdd0/storage<": true }
    snapshotting:
      type: periodic
      interval: 4h
      prefix: zrepl_
    pruning:
      keep:
        # fade-out scheme for snapshots starting with `zrepl_`
        # - keep all created in the last day (6 per day)
        # - then destroy snapshots such that we keep 7 each 1 day apart
        # - then destroy snapshots such that we keep 12 each 1 month apart
        # ...More snapshots at restic snapshots
        - type: grid
          grid: 6x4h(keep=all) | 7x1d | 12x30d
          regex: "^zrepl_.*"
        # keep all snapshots that don't have the `zrepl_` prefix
        - type: regex
          negate: true
          regex: "^zrepl_.*"

  # backup hdd0/storage & hdd0/other to hdd1
  - type: push
    name: backup_hdd0
    connect:
      type: local
      listener_name: hdd1_sink
      client_identity: hdd0_backup
    filesystems: { "hdd0/storage<": true, "hdd0/other<": true }
    send:
      encrypted: true
    replication:
      protection:
        initial: guarantee_incremental
        incremental: guarantee_incremental
    snapshotting:
      type: manual
    pruning:
      # no-op prune rule on sender (keep all snapshots), job `rpool_and_hdd_snapshot` takes care of this
      keep_sender:
        - type: regex
          regex: ".*"
      # retain
      keep_receiver:
        - type: last_n
          count: 1
          regex: "^zrepl_.*"
        # retain all non-zrepl snapshots on the backup drive
        - type: regex
          negate: true
          regex: "^zrepl_.*"

  # backup rpool/data & ROOT to hdd1
  - type: push
    name: backup_rpool
    connect:
      type: local
      listener_name: hdd1_sink
      client_identity: rpool_backup
    filesystems: { "rpool/data<": true, "rpool/ROOT<": true }
    send:
      encrypted: true
    replication:
      protection:
        initial: guarantee_incremental
        incremental: guarantee_incremental
    snapshotting:
      type: manual
    pruning:
      # no-op prune rule on sender (keep all snapshots), snapshot job takes care of this
      keep_sender:
        - type: regex
          regex: ".*"
      # retain
      keep_receiver:
        - type: last_n
          count: 1
          regex: "^zrepl_.*"
        # retain all non-zrepl snapshots on the backup drive
        - type: regex
          negate: true
          regex: "^zrepl_.*"

  - type: sink
    name: hdd1_sink
    root_fs: "hdd1"
    recv:
      placeholder:
        encryption: off
    serve:
      type: local
      listener_name: hdd1_sink

  - type: sink
    name: hdd0_sink
    root_fs: "hdd0"
    recv:
      placeholder:
        encryption: off
    serve:
      type: local
      listener_name: hdd0_sink
