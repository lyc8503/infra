name: Infrastructure backup Test

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 3'


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Build the Docker image
        run: |
          sudo apt install -y bzip2

          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-current-linux-amd64.zip
          cd rclone-*-linux-amd64
          sudo cp rclone /usr/bin/
          sudo chown root:root /usr/bin/rclone
          sudo chmod 755 /usr/bin/rclone
          cd ..

          curl -O https://github.com/restic/restic/releases/download/v0.17.0/restic_0.17.0_linux_amd64.bz2
          bz2 -d restic_0.17.0_linux_amd64.bz2
          sudo cp restic_0.17.0_linux_amd64 /usr/bin/restic
          sudo chown root:root /usr/bin/restic
          sudo chmod 755 /usr/bin/restic

          mkdir ~/.config
          mkdir ~/.config/rclone
          echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf

          restic check --verbose --read-data
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
          RESTIC_REPOSITORY: ${{ secrets.RESTIC_REPOSITORY }}
          RESTIC_PASSWORD: ${{ secrets.RESTIC_PASSWORD }}